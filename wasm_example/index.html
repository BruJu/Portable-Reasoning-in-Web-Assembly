<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff" http-equiv="Content-Type" />
    <title>Rust Wasm Example</title>
    <style>
        #loaded_graph {
            font-family: Consolas, monaco, monospace;
            font-size: 0.7em;
        }
    </style>
</head>

<body>
    <h1>Sophia in the browser</h1>

    <h2>Loaded graph</h2>
    <p id="loaded_graph">None</p>

    <h2>Detected terms</h2>
    <ul id="detected_terms"></ul>

    <p id="equal_state"></p>
    
    <script src="wasm_example.js"></script>
    <script>
        // We define these as global variables to let the user test with the console
        var graph;
        var d;
        var list_of_terms;

        function escapeHtml(unsafe) {
            // Author of this function :  bjornd - https://stackoverflow.com/a/6234804
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // wasm binding
        async function run(){
            await wasm_bindgen('wasm_example_bg.wasm');
            
            graph = 
                '@prefix xsd: <http://www.w3.org/2001/XMLSchema#> . \n' +
                '@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> . \n' +
                '@base <http://bruy.at/rdf/> . \n\n' +
                '<personnes/#Julian> a <#stagiaire> . \n' +
                '<personnes/#Thomas> a <#stagiaire> . \n' +
                '<personnes/#Julian> <concept/#prenom> "Julian" . \n' +
                '_:blanknode <concept/#idk> <personnes/#Julian> . \n' +
                '_:blanknode <concept/#idk> _:anotherblanknode . \n' +
                '_:anotherblanknode <concept/#aaa> 5 . \n' +
                '_:anotherblanknode <concept/#abc> 6.24 . \n' +
                '<concept/#conceptuel> <concept/#conceptuel> "Chat"@fr . \n' +
                '<http://dbpedia.org/resource/Cat> <concept/#nom> "Chat"@fr . \n' +
                '<http://dbpedia.org/resource/Cat> <concept/#nom> "Cat" . \n' +        // string != langString
                '<http://dbpedia.org/resource/Cat> <concept/#nom> "Cat"@en . \n' +
                '<http://dbpedia.org/resource/Cat> <concept/#nom> "Gato"@es . \n' + // Test same name in different languages
                '<http://dbpedia.org/resource/Cat> <concept/#nom> "Gato"@pt . \n';

            document.getElementById("loaded_graph").innerText = graph;
            
            d = new wasm_bindgen.JSDataset();
            d.load(graph);

            list_of_terms = d.getTerms();

            { // Display list of terms
                let rawHtml = "";
                for (let i in list_of_terms) {
                    let str = list_of_terms[i].toString();
                    rawHtml += "<li>" + escapeHtml(str) + "</li>"
                }
                document.getElementById("detected_terms").innerHTML = rawHtml;
            }

            { // Equality test
                let total_same_equals = 0;
                let total_same_inequals = 0;

                for (let term_a of list_of_terms) {
                    for (let term_b of list_of_terms) {
                        let n3_eq = term_a.toString() == term_b.toString();
                        let eq = term_a.equals(term_b);

                        if (n3_eq && eq) {
                            total_same_equals++;
                        } else if (!n3_eq && !eq) {
                            total_same_equals++;
                        } else {
                            total_same_inequals++;
                            console.log(term_a.n3() + " and " + term_b.n3() + " are strange");
                        }
                    }
                }

                let message;

                if (total_same_inequals != 0) {
                    message = "Equality check : " + total_same_equals + " n3==equals / " + total_same_inequals + " n3!=equals";
                    console.log(message);
                } else {
                    message = "Equality check passed.";
                }

                document.getElementById("equal_state").innerText = message;
            }
        }

        run();
        //do not put anything after run()!!!!!!!!
    </script>

    <!-- <script>
        let g;
        wasm_bindgen('wasm_example_bg.wasm').then(()=>{
            console.log(wasm_bindgen.run_alert);
            wasm_bindgen.run_alert("JavaScript");
            g = wasm_bindgen.make_graph();
            return fetch(my_url);
        }).then((reesp) => {
            g.load(resp.content)
        })
        //do not put anything after run()!!!!!!!!

    </script> -->

    <!--<script src="./src/index.js"></script>-->
</body>

</html>