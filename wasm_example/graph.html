<!DOCTYPE html>
<html>
    <head>
        <title>Sophia in the Browser - Graph Manipulation</title>
        <meta content="text/html; charset=UTF-8"></meta>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <header>
            <h1>Sophia in the Browser</h1>
        </header>
        <div class="main">
            <div id="div_graph">
                <h2>Graph</h2>
                <div id="div_graph_static">
                    <p id="graph_text">No graph loaded</p>
                    <p class="center">
                        <input type="button" value="Modify" onclick="action_graph_modify()">
                    </p>
                </div>
                <div id="div_graph_textarea">
                    <p class="graph_content_container"><textarea id="graph_content" rows="20"></textarea></p>
                    <p class="center"><input type="button" value="Send" onclick="action_graph_send()">
                        <input type="button" value="Cancel" onclick="action_graph_cancel()"></p>
                </div>
            </div>
            <div id="div_terms" class="center">
                <h2>Terms</h2>
                <p>
                    <select id="select_terms" size="20">
                    </select>
                </p>
                <p>
                    <input type="button" value="Remove unused terms" onclick="action_terms_clear()">
                </p>
                <p>
                    <input id="terms_new_term_name" type="text" placeholder="Value">
                    <input id="terms_new_term_lang" type="text" placeholder="Language">
                    <input id="terms_new_term_datatype" type="text" placeholder="Datatype">
                </p>
                <p>
                    <input type="button" value="Add named node" onclick="action_terms_add('NamedNode')">
                    <input type="button" value="Add blank node" onclick="action_terms_add('BlankNode')">
                    <input type="button" value="Add literal" onclick="action_terms_add('Literal')">
                    <input type="button" value="Add variable" onclick="action_terms_add('Variable')">
                </p>
            </div>
            <div>
                <h2>Query</h2>
                <p><label>Subject : </label>
                    <select id="query_s">
                    </select>
                    <br>
                    <select id="query_p">
                    </select>
                    <select id="query_o">
                    </select>
                    <select id="query_g">
                        <option>Default Graph<option>
                    </select>
                    <br><input type="button" value="Add"> <input type="button" value="Remove"> <input type="button" value="Match"> <input type="button" value="Has">
                </p>
                <h3>Query Answer</h3>
                <p>
                    <select id="select_query_answer" size="2">
                    </select>
                </p>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
        <script src="wasm_example.js"></script>
        <script>
            function escapeHtml(unsafe) {
                // Author of this function :  bjornd - https://stackoverflow.com/a/6234804
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // TODO : is_activ -> is_active

            class Context {
                constructor() {
                    this.is_activ = false;
                    this.has_been_modified_seen_last_update = false;
                }

                loadGraphe(grapheToLoad) {
                    this.rustGraph = new wasm_bindgen.JSDataset();
                    this.rustGraph.load(grapheToLoad);
                    this.datafactory = this.rustGraph.cloneFactory();
                    this.is_activ = true;
                    if (this.rustGraph.getTerms === undefined) {
                        this.list_of_terms = [];
                        alert("Could not load terms : you are probably not using Sophia as the RDF JS backend");
                    } else {
                        this.list_of_terms = this.rustGraph.getTerms();
                        this.sort_terms();
                    }
                    this.updateHTML("LOAD_GRAPH", grapheToLoad);
                }

                sort_terms() {
                    let strCmp = (a, b) => {
                        if (a < b) {
                            return -1;
                        } else if (a > b) {
                            return 1;
                        } else {
                            return 0;
                        }
                    }

                    this.list_of_terms.sort((t1, t2) => {
                        let r = strCmp(t1.termType, t2.termType);
                        if (r != 0) {
                            return r;
                        }

                        return strCmp(t1.value, t2.value);
                    });
                }
            
                get_turtle_file() {
                    this.has_been_modified_seen_last_update = false;
                    return "NOT YET IMPLEMENTED";
                }
            
                updateHTML(event, extra_str) {
                    if (event == "LOAD_GRAPH") {
                        console.log(extra_str);
                        $('#graph_text').text(extra_str);
                        $('#graph_content').val(extra_str);
                        this.updateHTML("MODIFY_TERMS");
                    } else if (event == "MODIFY_TERMS") {
                        let select_terms = $('#select_terms');
                        select_terms.empty();

                        for (let i in this.list_of_terms) {
                            let term_in_string = this.list_of_terms[i].toString();
                            let html = `<option value="${i}">${escapeHtml(term_in_string)}</option>`;
                            select_terms.append(html);
                        }
                    } else if (event == "NEW_TERM") {
                        let select_terms = $('#select_terms');
                        let term_in_string = extra_str.toString();
                        let html = `<option value="${select_terms.length - 1}">${escapeHtml(term_in_string)}</option>`;
                        select_terms.append(html);
                    }
                }

                reloadTerms() {
                    this.list_of_terms = this.rustGraph.getTerms();
                    this.sort_terms();
                    this.updateHTML("MODIFY_TERMS")
                }

                addNewTerm(newTerm) {
                    this.list_of_terms.push(newTerm);
                    this.updateHTML("NEW_TERM", newTerm);
                }

                addNewTermByText(nodeContent, nodeType) {
                    let newNode = null;
                    if (nodeType === "NamedNode") {
                        newNode = this.datafactory.namedNode(nodeContent['value']);
                    } else if (nodeType === "BlankNode") {
                        newNode = this.datafactory.blankNode(nodeContent['value']);
                    } else if (nodeType === "Variable") {
                        newNode = this.datafactory.variable(nodeContent['value']);
                    } else if (nodeType === "Literal") {
                        if (nodeContent['lang'] !== "") {
                            newNode = this.datafactory.literal(nodeContent['value'], nodeContent['lang']);
                        } else {
                            if (nodeContent['type'] === "") {
                                nodeContent['type'] = "http://www.w3.org/2001/XMLSchema#string";
                            }

                            newNode = this.datafactory.namedNode(nodeContent['type']);
                            if (newNode === null) {
                                return false;
                            }

                            newNode = this.datafactory.literal(nodeContent['value'], newNode);
                        }
                    }

                    if (newNode == null) {
                        return false;
                    }

                    this.addNewTerm(newNode);

                    return true;
                }
            };

            function action_graph_modify() {
                $('#div_graph_static').css('display', 'none');
                $('#div_graph_textarea').css('display', 'block');

                if (!context.is_activ) {
                    return;
                }

                if (context.has_been_modified_seen_last_update) {
                    $('graph_content').val(context.get_turtle_file());
                }
            }

            function action_graph_send() {
                $('#div_graph_static').css('display', 'block');
                $('#div_graph_textarea').css('display', 'none');

                const new_graph = $('#graph_content').val();
                context.loadGraphe(new_graph);
            }

            function action_graph_cancel() {
                $('#div_graph_static').css('display', 'block');
                $('#div_graph_textarea').css('display', 'none');
            }

            function action_terms_clear() {
                if (!context.is_activ) {
                    return;
                }

                const currentlySelectedIndex = $('#select_terms').val();
                const currentlySelectedText = currentlySelectedIndex === null ?
                    null : context.list_of_terms[parseInt(currentlySelectedIndex)].toString();

                context.reloadTerms();

                if (currentlySelectedText === null) {
                    return;
                }

                for (const i in context.list_of_terms) {
                    if (context.list_of_terms[i].toString() == currentlySelectedText) {
                        $('#select_terms option[value="'+i+'"]').prop('selected', true);
                        break;
                    }
                }
            }

            function action_terms_add(term_kind) {
                if (!context.is_activ) {
                    return;
                }

                const nodeValue = $('#terms_new_term_name').val();
                const nodeLang = $('#terms_new_term_lang').val();
                const nodeType = $('#terms_new_term_datatype').val();

                let nodeContent = {
                    value: nodeValue, lang: nodeLang, type: nodeType
                }

                if (context.addNewTermByText(nodeContent, term_kind)) {
                    $('terms_new_term_name').val("");
                    $('terms_new_term_lang').val("");
                    $('terms_new_term_datatype').val("");
                }
            }

            var context = new Context();

            $(document).ready(function() {
                async function run() {
                    await wasm_bindgen('wasm_example_bg.wasm');

                    const firstGraphe =
                        '@prefix xsd: <http://www.w3.org/2001/XMLSchema#> . \n' +
                        '@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> . \n' +
                        '@base <http://bruy.at/rdf/> . \n\n' +
                        '<personnes/#Julian> a <#stagiaire> . \n' +
                        '<personnes/#Thomas> a <#stagiaire> . \n' +
                        '<personnes/#Julian> <concept/#prenom> "Julian" . \n' +
                        '_:blanknode <concept/#idk> <personnes/#Julian> . \n' +
                        '_:blanknode <concept/#idk> _:anotherblanknode . \n' +
                        '_:anotherblanknode <concept/#aaa> 5 . \n' +
                        '_:anotherblanknode <concept/#abc> 6.24 . \n' +
                        '<concept/#conceptuel> <concept/#conceptuel> "Chat"@fr . \n' +
                        '<http://dbpedia.org/resource/Cat> <concept/#nom> "Chat"@fr . \n' +
                        '<http://dbpedia.org/resource/Cat> <concept/#nom> "Cat" . \n' +        // string != langString
                        '<http://dbpedia.org/resource/Cat> <concept/#nom> "Cat"@en . \n' +
                        '<http://dbpedia.org/resource/Cat> <concept/#nom> "Gato"@es . \n' + // Test same name in different languages
                        '<http://dbpedia.org/resource/Cat> <concept/#nom> "Gato"@pt . \n';

                    context.loadGraphe(firstGraphe);
                }
                    
                run();
            });
        </script>
    </body>
</html>